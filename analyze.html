<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Audio - Reproductor Inteligente</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/analyze.css">
</head>
<body>
    <header class="bg-dark text-white py-3 mb-4">
        <div class="container d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Reproductor Inteligente</h2>
            <div>
                <a href="index.html" class="btn btn-outline-light me-2">
                    <i class="bi bi-music-player me-2"></i>Reproductor
                </a>
                <a href="list_songs.php" class="btn btn-outline-light">
                    <i class="bi bi-music-note-list me-2"></i>Listado
                </a>
            </div>
        </div>
    </header>
    
    <div class="container py-4">
        <h1 class="mb-4">
            <i class="bi bi-soundwave me-2"></i>Analizador de Audio
        </h1>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-cloud-upload me-2"></i>Subir Archivo de Audio</span>
                    </div>
                    <div class="card-body">
                        <div id="dropzone" class="dropzone mb-3">
                            <i class="bi bi-file-earmark-music dropzone-icon"></i>
                            <h5>Arrastra un archivo de audio o haz clic para seleccionar</h5>
                            <p class="text-muted">Formatos soportados: MP3, WAV, OGG, M4A</p>
                            <input type="file" id="audioFileInput" accept="audio/*" class="d-none">
                        </div>
                        
                        <div id="selectedFile" class="d-none mb-3">
                            <div class="d-flex align-items-center p-3 bg-dark rounded">
                                <i class="bi bi-file-earmark-music me-3 fs-3"></i>
                                <div class="flex-grow-1">
                                    <h6 id="fileName" class="mb-1">nombre_archivo.mp3</h6>
                                    <small id="fileSize" class="text-muted">0 MB</small>
                                </div>
                                <button id="removeFile" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button id="analyzeButton" class="btn btn-danger" disabled>
                                <i class="bi bi-graph-up me-2"></i>Analizar Audio
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sección de análisis (inicialmente oculta) -->
        <div id="analysisSection" class="d-none">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-activity me-2"></i>Progreso del Análisis
                        </div>
                        <div class="card-body">
                            <div id="analysisProgress" class="progress mb-3">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <p id="analysisStatus" class="text-center mb-0">Preparando análisis...</p>
                            
                            <div id="loadingAnimation" class="loading-animation mt-3">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resultados del análisis (inicialmente ocultos) -->
        <div id="resultsSection" class="d-none">
            <div class="row mb-4">
                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-soundwave me-2"></i>Visualización
                        </div>
                        <div class="card-body">
                            <div class="visualizer-container">
                                <canvas id="visualizer"></canvas>
                            </div>
                            
                            <div class="mt-3">
                                <audio id="audioPlayer" controls class="w-100"></audio>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-4">
                    <div class="card result-card h-100">
                        <div class="card-body text-center py-4">
                            <div class="result-value" id="bpmValue">0</div>
                            <div class="result-label">BPM (Pulsos por Minuto)</div>
                            <div class="mt-3 text-muted" id="bpmDescription">
                                Velocidad de la canción
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-4">
                    <div class="card result-card h-100" style="border-left-color: #ff8a80;">
                        <div class="card-body text-center py-4">
                            <div class="result-value" id="dynamicsValue" style="color: #ff8a80;">-</div>
                            <div class="result-label">Dinámica</div>
                            <div class="mt-3 text-muted" id="dynamicsDescription">
                                Variación de volumen
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-4">
                    <div class="card result-card h-100" style="border-left-color: #80cbc4;">
                        <div class="card-body text-center py-4">
                            <div class="result-value" id="brightnessValue" style="color: #80cbc4;">-</div>
                            <div class="result-label">Brillo</div>
                            <div class="mt-3 text-muted" id="brightnessDescription">
                                Presencia de agudos
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-4">
                    <div class="card result-card h-100" style="border-left-color: #ffe082;">
                        <div class="card-body text-center py-4">
                            <div class="result-value" id="complexityValue" style="color: #ffe082;">-</div>
                            <div class="result-label">Complejidad</div>
                            <div class="mt-3 text-muted" id="complexityDescription">
                                Variación musical
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-lightning-charge me-2"></i>Actividades Recomendadas
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">Basado en el BPM y la energía de esta canción, estas actividades son ideales:</p>
                            <div id="activitiesList" class="d-flex flex-wrap">
                                <!-- Las actividades se agregarán dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-save me-2"></i>Guardar en Biblioteca
                        </div>
                        <div class="card-body">
                            <form id="saveForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="songTitle" class="form-label">Título</label>
                                        <input type="text" class="form-control bg-dark text-white" id="songTitle" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="songArtist" class="form-label">Artista</label>
                                        <input type="text" class="form-control bg-dark text-white" id="songArtist" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="songYear" class="form-label">Año</label>
                                        <input type="number" class="form-control bg-dark text-white" id="songYear" min="1900" max="2099">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="songGenre" class="form-label">Género</label>
                                        <select class="form-select bg-dark text-white" id="songGenre">
                                            <option value="">Seleccionar género</option>
                                            <option value="rock">Rock</option>
                                            <option value="pop">Pop</option>
                                            <option value="electronic">Electrónica</option>
                                            <option value="classical">Clásica</option>
                                            <option value="jazz">Jazz</option>
                                            <option value="hiphop">Hip Hop</option>
                                            <option value="latin">Latina</option>
                                            <option value="other">Otro</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="text-center mt-3">
                                    <button type="submit" class="btn btn-danger">
                                        <i class="bi bi-plus-circle me-2"></i>Añadir a Biblioteca
                                    </button>
                                </div>
                                <div id="saveResult" class="mt-3 d-none alert" role="alert"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Nuestro analizador de audio simplificado -->
    <script src="js/simple-audio-analyzer.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Referencias a elementos DOM
            const dropzone = document.getElementById('dropzone');
            const audioFileInput = document.getElementById('audioFileInput');
            const selectedFile = document.getElementById('selectedFile');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const removeFile = document.getElementById('removeFile');
            const analyzeButton = document.getElementById('analyzeButton');
            const analysisSection = document.getElementById('analysisSection');
            const resultsSection = document.getElementById('resultsSection');
            const progressBar = document.querySelector('.progress-bar');
            const analysisStatus = document.getElementById('analysisStatus');
            const loadingAnimation = document.getElementById('loadingAnimation');
            const audioPlayer = document.getElementById('audioPlayer');
            const visualizer = document.getElementById('visualizer');
            
            // Variables para almacenar datos
            let selectedAudioFile = null;
            let audioContext = null;
            let audioBuffer = null;
            let analyzerNode = null;
            let sourceNode = null;
            let animationFrame = null;
            
            // Inicializar el contexto de audio
            function initAudioContext() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                return audioContext;
            }
            
            // Eventos para el dropzone
            dropzone.addEventListener('click', function() {
                audioFileInput.click();
            });
            
            dropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });
            
            dropzone.addEventListener('dragleave', function() {
                dropzone.classList.remove('dragover');
            });
            
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
            
            // Manejar la selección de archivos
            audioFileInput.addEventListener('change', function() {
                if (audioFileInput.files.length > 0) {
                    handleFileSelection(audioFileInput.files[0]);
                }
            });
            
            // Función para manejar la selección de archivos
            function handleFileSelection(file) {
                // Verificar que sea un archivo de audio
                if (!file.type.startsWith('audio/')) {
                    alert('Por favor, selecciona un archivo de audio válido.');
                    return;
                }
                
                selectedAudioFile = file;
                
                // Mostrar información del archivo
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                selectedFile.classList.remove('d-none');
                
                // Habilitar botón de análisis
                analyzeButton.disabled = false;
                
                // Actualizar la fuente del reproductor de audio
                audioPlayer.src = URL.createObjectURL(file);
            }
            
            // Formatear tamaño de archivo
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
                else return (bytes / 1048576).toFixed(2) + ' MB';
            }
            
            // Eliminar archivo seleccionado
            removeFile.addEventListener('click', function() {
                selectedAudioFile = null;
                selectedFile.classList.add('d-none');
                analyzeButton.disabled = true;
                audioPlayer.src = '';
                
                // Reiniciar input de archivo
                audioFileInput.value = '';
            });
            
            // Analizar audio
            analyzeButton.addEventListener('click', async function() {
                if (!selectedAudioFile) return;
                
                // Mostrar sección de análisis
                analysisSection.classList.remove('d-none');
                resultsSection.classList.add('d-none');
                
                // Actualizar progreso
                updateProgress(0, 'Inicializando análisis...');
                
                try {
                    // Analizar el audio con Essentia.js
                    const results = await SimpleAudioAnalyzer.analyzeAudio(selectedAudioFile, updateProgress);
                    
                    // Mostrar resultados
                    displayResults(results);
                    
                    // Ocultar sección de análisis y mostrar resultados
                    analysisSection.classList.add('d-none');
                    resultsSection.classList.remove('d-none');
                    
                    // Inicializar visualizador
                    initVisualizer();
                    
                } catch (error) {
                    console.error('Error al analizar audio:', error);
                    updateProgress(0, 'Error al analizar el audio. Por favor, intenta con otro archivo.');
                    setTimeout(() => {
                        analysisSection.classList.add('d-none');
                    }, 3000);
                }
            });
            
            // Actualizar progreso
            function updateProgress(percent, status) {
                progressBar.style.width = percent + '%';
                analysisStatus.textContent = status;
                
                // Mostrar/ocultar animación de carga
                if (percent >= 100) {
                    loadingAnimation.classList.add('d-none');
                } else {
                    loadingAnimation.classList.remove('d-none');
                }
            }
            
            // Mostrar resultados
            function displayResults(results) {
                // Guardar resultados para uso posterior (al guardar en la base de datos)
                analysisResults = results;
                
                // Actualizar valores
                document.getElementById('bpmValue').textContent = results.bpm;
                document.getElementById('dynamicsValue').textContent = formatPercentage(results.dynamics);
                document.getElementById('brightnessValue').textContent = formatPercentage(results.brightness);
                document.getElementById('complexityValue').textContent = formatPercentage(results.complexity);
                
                // Actualizar descripciones
                updateBpmDescription(results.bpm);
                updateDynamicsDescription(results.dynamics);
                updateBrightnessDescription(results.brightness);
                updateComplexityDescription(results.complexity);
                
                // Mostrar actividades recomendadas
                displayActivities(results.bpm, results.energy);
                
                // Pre-llenar el título si es posible
                if (selectedAudioFile && selectedAudioFile.name) {
                    // Extraer nombre de archivo sin extensión
                    const fileName = selectedAudioFile.name.replace(/\.[^/.]+$/, "");
                    document.getElementById('songTitle').value = fileName;
                }
            }
            
            // Formatear porcentaje
            function formatPercentage(value) {
                return Math.round(value * 100) + '%';
            }
            
            // Formatear tonalidad
            function formatKey(key, scale) {
                return key + (scale === 'major' ? ' Mayor' : ' Menor');
            }
            
            // Formatear energía
            function formatEnergy(energy) {
                return Math.round(energy * 100) + '%';
            }
            
            // Actualizar descripción de BPM
            function updateBpmDescription(bpm) {
                let description = '';
                
                if (bpm < 70) {
                    description = 'Tempo lento, ideal para relajación';
                } else if (bpm < 100) {
                    description = 'Tempo moderado, adecuado para actividades cotidianas';
                } else if (bpm < 120) {
                    description = 'Tempo medio-alto, bueno para caminatas';
                } else if (bpm < 140) {
                    description = 'Tempo alto, perfecto para correr';
                } else {
                    description = 'Tempo muy alto, ideal para entrenamientos intensos';
                }
                
                document.getElementById('bpmDescription').textContent = description;
            }
            
            // Actualizar descripción de dinámica
            function updateDynamicsDescription(dynamics) {
                let description = '';
                
                if (dynamics < 0.3) {
                    description = 'Poca variación de volumen, constante';
                } else if (dynamics < 0.6) {
                    description = 'Variación moderada, expresiva';
                } else {
                    description = 'Gran variación, muy dinámica';
                }
                
                document.getElementById('dynamicsDescription').textContent = description;
            }
            
            // Actualizar descripción de brillo
            function updateBrightnessDescription(brightness) {
                let description = '';
                
                if (brightness < 0.3) {
                    description = 'Sonido oscuro, predominan graves';
                } else if (brightness < 0.6) {
                    description = 'Sonido equilibrado en frecuencias';
                } else {
                    description = 'Sonido brillante, predominan agudos';
                }
                
                document.getElementById('brightnessDescription').textContent = description;
            }
            
            // Actualizar descripción de complejidad
            function updateComplexityDescription(complexity) {
                let description = '';
                
                if (complexity < 0.3) {
                    description = 'Estructura simple y repetitiva';
                } else if (complexity < 0.6) {
                    description = 'Complejidad moderada, variada';
                } else {
                    description = 'Estructura compleja, muchos cambios';
                }
                
                document.getElementById('complexityDescription').textContent = description;
            }
            
            // Mostrar actividades recomendadas
            function displayActivities(bpm, energy) {
                const activitiesList = document.getElementById('activitiesList');
                activitiesList.innerHTML = '';
                
                const activities = SimpleAudioAnalyzer.suggestActivities(bpm, energy);
                
                activities.forEach(activity => {
                    const badge = document.createElement('div');
                    badge.className = 'activity-badge';
                    badge.textContent = activity;
                    activitiesList.appendChild(badge);
                });
            }
            
            // Inicializar visualizador de audio
            function initVisualizer() {
                if (!audioPlayer.src) return;
                
                const ctx = visualizer.getContext('2d');
                const audioCtx = initAudioContext();
                
                // Configurar tamaño del canvas
                visualizer.width = visualizer.clientWidth;
                visualizer.height = visualizer.clientHeight;
                
                // Crear nodos de audio
                analyzerNode = audioCtx.createAnalyser();
                analyzerNode.fftSize = 256;
                const bufferLength = analyzerNode.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                // Conectar nodos
                sourceNode = audioCtx.createMediaElementSource(audioPlayer);
                sourceNode.connect(analyzerNode);
                analyzerNode.connect(audioCtx.destination);
                
                // Función para dibujar
                function draw() {
                    // Limpiar canvas
                    ctx.clearRect(0, 0, visualizer.width, visualizer.height);
                    
                    // Obtener datos de frecuencia
                    analyzerNode.getByteFrequencyData(dataArray);
                    
                    // Configuración para dibujar
                    const barWidth = (visualizer.width / bufferLength) * 2.5;
                    let x = 0;
                    
                    // Dibujar cada barra
                    for (let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * visualizer.height;
                        
                        // Gradiente de color basado en la frecuencia
                        const hue = i / bufferLength * 360;
                        ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                        
                        // Dibujar barra
                        ctx.fillRect(x, visualizer.height - barHeight, barWidth, barHeight);
                        
                        x += barWidth + 1;
                    }
                    
                    // Solicitar siguiente frame
                    animationFrame = requestAnimationFrame(draw);
                }
                
                // Iniciar visualización cuando se reproduce
                audioPlayer.addEventListener('play', function() {
                    if (animationFrame) cancelAnimationFrame(animationFrame);
                    draw();
                });
                
                // Detener visualización cuando se pausa
                audioPlayer.addEventListener('pause', function() {
                    if (animationFrame) cancelAnimationFrame(animationFrame);
                });
                
                // Detener visualización cuando termina
                audioPlayer.addEventListener('ended', function() {
                    if (animationFrame) cancelAnimationFrame(animationFrame);
                });
            }
            
            // Variables para almacenar los resultados del análisis
            let analysisResults = null;
            
            // Manejar envío del formulario para guardar canción
            document.getElementById('saveForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!analysisResults) {
                    showSaveResult('error', 'No hay resultados de análisis para guardar');
                    return;
                }
                
                // Obtener datos del formulario
                const title = document.getElementById('songTitle').value;
                const artist = document.getElementById('songArtist').value;
                const year = document.getElementById('songYear').value;
                const genre = document.getElementById('songGenre').value;
                
                // Validar datos básicos
                if (!title || !artist) {
                    showSaveResult('error', 'El título y el artista son obligatorios');
                    return;
                }
                
                // Preparar datos para enviar
                const songData = {
                    title: title,
                    artist: artist,
                    year: year ? parseInt(year) : null,
                    bpm: analysisResults.bpm,
                    // Nuevas características de audio
                    dynamics: analysisResults.dynamics,
                    brightness: analysisResults.brightness,
                    complexity: analysisResults.complexity,
                    rhythm: analysisResults.rhythm || 0.7, // Usar 0.7 como valor por defecto si no existe
                    // Mantener compatibilidad con campos existentes
                    energy: analysisResults.energy,
                    key: analysisResults.key,
                    scale: analysisResults.scale,
                    // Estos valores son aproximados basados en las nuevas características
                    danceability: calculateDanceability(analysisResults.bpm, analysisResults.dynamics || 0.5),
                    happiness: calculateHappiness(analysisResults.key, analysisResults.scale, analysisResults.brightness || 0.5),
                    instrumentalness: 0.3, // Valor por defecto
                    audioUrl: audioPlayer.src.split('/').pop() // Extraer nombre de archivo de la URL
                };
                
                // Mostrar indicador de carga
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Guardando...';
                
                // Enviar datos al servidor
                fetch('save_analysis.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(songData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSaveResult('success', 'Canción guardada correctamente con ID: ' + data.songId);
                        // Limpiar formulario
                        document.getElementById('saveForm').reset();
                    } else {
                        showSaveResult('error', data.message || 'Error al guardar la canción');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showSaveResult('error', 'Error de conexión al guardar la canción');
                })
                .finally(() => {
                    // Restaurar botón
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                });
            });
            
            // Función para mostrar resultados del guardado
            function showSaveResult(type, message) {
                const resultDiv = document.getElementById('saveResult');
                resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
                resultDiv.classList.add(type === 'success' ? 'alert-success' : 'alert-danger');
                resultDiv.textContent = message;
                
                // Ocultar después de 5 segundos
                setTimeout(() => {
                    resultDiv.classList.add('d-none');
                }, 5000);
            }
            
            // Función para calcular danceability aproximada
            function calculateDanceability(bpm, energy) {
                // BPM entre 90-130 son generalmente más bailables
                const bpmFactor = 1 - Math.abs((bpm - 110) / 110);
                return Math.min(1, Math.max(0, (bpmFactor * 0.6 + energy * 0.4)));
            }
            
            // Función para calcular happiness aproximada
            function calculateHappiness(key, scale, energy) {
                // Escalas mayores suelen sonar más felices que menores
                const scaleBonus = scale === 'major' ? 0.3 : 0;
                return Math.min(1, Math.max(0, (energy * 0.7 + scaleBonus)));
            }
        });
    </script>
</body>
</html>
